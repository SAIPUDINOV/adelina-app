name: Build Android APK

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Install wget
      run: sudo apt-get update && sudo apt-get install -y wget
    
    - name: Create project files
      run: |
        # Создаем папки
        mkdir -p app/src/main/java/com/adelina/app/
        mkdir -p app/src/main/res/layout/
        
        # Создаем AndroidManifest.xml
        echo '<?xml version="1.0" encoding="utf-8"?>
        <manifest xmlns:android="http://schemas.android.com/apk/res/android">
          <uses-permission android:name="android.permission.INTERNET"/>
          <application android:label="Adelina Space">
            <activity android:name=".MainActivity" android:exported="true">
              <intent-filter>
                <action android:name="android.intent.action.MAIN"/>
                <category android:name="android.intent.category.LAUNCHER"/>
              </intent-filter>
            </activity>
          </application>
        </manifest>' > app/src/main/AndroidManifest.xml
        
        # Создаем layout
        echo '<?xml version="1.0" encoding="utf-8"?>
        <WebView xmlns:android="http://schemas.android.com/apk/res/android"
          android:id="@+id/webview"
          android:layout_width="match_parent"
          android:layout_height="match_parent"/>' > app/src/main/res/layout/activity_main.xml
        
        # Создаем Activity
        echo 'package com.adelina.app;
        import android.app.Activity;
        import android.os.Bundle;
        import android.webkit.WebView;
        import android.webkit.WebViewClient;
        
        public class MainActivity extends Activity {
          @Override
          protected void onCreate(Bundle savedInstanceState) {
            super.onCreate(savedInstanceState);
            setContentView(R.layout.activity_main);
            WebView webView = findViewById(R.id.webview);
            webView.getSettings().setJavaScriptEnabled(true);
            webView.setWebViewClient(new WebViewClient());
            webView.loadUrl("https://adelina.space/home.aspx");
          }
        }' > app/src/main/java/com/adelina/app/MainActivity.java
        
        # Создаем build.gradle с правильной версией Gradle
        echo 'buildscript {
          repositories {
            google()
            mavenCentral()
          }
          dependencies {
            classpath "com.android.tools.build:gradle:8.1.2"
          }
        }
        
        apply plugin: "com.android.application"
        
        android {
          namespace "com.adelina.app"
          compileSdk 34
          
          defaultConfig {
            applicationId "com.adelina.app"
            minSdk 21
            targetSdk 34
            versionCode 1
            versionName "1.0"
          }
          
          buildTypes {
            release {
              minifyEnabled false
            }
          }
          
          compileOptions {
            sourceCompatibility JavaVersion.VERSION_1_8
            targetCompatibility JavaVersion.VERSION_1_8
          }
        }
        
        dependencies {
          implementation "androidx.appcompat:appcompat:1.6.1"
        }' > app/build.gradle
        
        echo 'include ":app"' > settings.gradle
    
    - name: Build with Gradle 8.2
      run: |
        # Скачиваем Gradle 8.2
        wget https://services.gradle.org/distributions/gradle-8.2-bin.zip
        unzip gradle-8.2-bin.zip
        
        # Собираем APK
        ./gradle-8.2/bin/gradle assembleDebug
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: Adelina-App
        path: app/build/outputs/apk/debug/*.apk
